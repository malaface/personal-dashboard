services:
  postgres:
    image: postgres:15-alpine
    container_name: dashboard-db
    restart: unless-stopped
    ports:
      - "5435:5432"
    environment:
      POSTGRES_USER: dashboard_user
      POSTGRES_PASSWORD: "CU04bbYde+lhCOJcPaD8vYfjb9nXVJClur8xjDo6I88="
      POSTGRES_DB: dashboard
    volumes:
      - dashboard-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dashboard_user -d dashboard"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai-platform_default

  dashboard:
    image: personal-dashboard:production
    container_name: personal-dashboard
    restart: unless-stopped
    ports:
      - "3003:3000"
    environment:
      # Database (using dedicated PostgreSQL)
      DATABASE_URL: "postgresql://dashboard_user:CU04bbYde+lhCOJcPaD8vYfjb9nXVJClur8xjDo6I88=@dashboard-db:5432/dashboard"

      # NextAuth
      NEXTAUTH_URL: "http://localhost:3003"
      NEXTAUTH_SECRET: "QLyBcsLeH0WURxp9/uhBlipxG8ipVutArstCXY1dL3g="

      # Redis (using internal Docker network)
      REDIS_URL: "redis://:0Mb1vEXSc9xzRV5oE7PGnG80IhktTEeBtVsthKDite0=@redis:6379"

      # AI Platform Integration (using service names)
      N8N_BASE_URL: "http://n8n:5678"
      FLOWISE_BASE_URL: "http://flowise:3000"
      QDRANT_URL: "http://qdrant:6333"
      QDRANT_API_KEY: "d06abab773da23dadb49d2a3bc0a46bef210f9b8c2a37339654b3b5034bccc94"
      N8N_API_TOKEN: "8f604ace9ed5b11a486cba72338874b98d6effce2e7eac90d5173aa94d9fc076"

      # Resend Email Service
      RESEND_API_KEY: "re_2hbAs7Hg_9uXxyGJ2d97nmUzfF7VG8RRC"
      RESEND_FROM_EMAIL: "noreply@updates.malacaran8n.uk"

      # Node environment
      NODE_ENV: "production"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - ai-platform_default

    depends_on:
      postgres:
        condition: service_healthy

    labels:
      - "com.personal-dashboard.service=dashboard"
      - "com.personal-dashboard.version=production"
      - "prometheus.scrape=true"
      - "prometheus.port=3000"
      - "prometheus.path=/api/metrics"

volumes:
  dashboard-postgres-data:
    driver: local

networks:
  ai-platform_default:
    external: true
